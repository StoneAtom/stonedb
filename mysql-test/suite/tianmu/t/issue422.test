--source include/have_tianmu.inc

--disable_warnings

DROP DATABASE IF EXISTS issue422_test;

CREATE DATABASE issue422_test;

USE issue422_test;


## DDL

DROP TABLE IF EXISTS test1;

CREATE TABLE t1(id int, name varchar(20)) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;

## procedure

drop procedure if exists idata;

delimiter //;
create procedure idata(in num INT)
begin
  declare i int;
  set i=1;
  while(i<=num) do
    if (i < 200) then
      insert into t1 values(i, 'James');
    elseif (i >= 200 && i < 1500) then
      insert into t1 values(i, 'Lily');
    else
      insert into t1 values(i, 'Kevin');
    end if;
    set i=i+1;
  end while;
end //

delimiter ;//

## insert data

call idata(3000);

## log

set global tianmu_slow_query_record_interval=0;
set global tianmu_groupby_parallel_rows_minimum=1000;

## query 

## groupy bu of single thread

## set threads
set global tianmu_groupby_parallel_degree=0;

## query
select sum(id),name from t1 group by name order by name;

## groupy bu of multi thread

## set threads
set global tianmu_groupby_parallel_degree=2;

## query
select sum(id),name from t1 group by name order by name;

## log 

set global tianmu_slow_query_record_interval=2;

# clean

drop database issue422_test;