--source include/have_tianmu.inc

--disable_warnings

DROP DATABASE IF EXISTS issue422_test;

CREATE DATABASE issue422_test;

USE issue422_test;


## DDL

DROP TABLE IF EXISTS test1;

CREATE TABLE t1(id int, name varchar(20)) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;

## procedure

drop procedure if exists idata;

delimiter //;
create procedure idata(in num INT)
begin
  declare i int;
  set i=1;
  while(i<=num) do
    if (i < 200) then
      insert into t1 values(i, 'James');
    elseif (i >= 200 && i < 1500) then
      insert into t1 values(i, 'Lily');
    else
      insert into t1 values(i, 'Kevin');
    end if;
    set i=i+1;
  end while;
end //

delimiter ;//

## insert data

call idata(3000);

## log

set global tianmu_slow_query_record_interval=0;
set global tianmu_groupby_parallel_rows_minimum=1000;

## query 

## groupy bu of single thread

## set threads
set global tianmu_groupby_parallel_degree=0;

## query
select sum(id),name from t1 group by name order by name;

## groupy bu of multi thread

## set threads
set global tianmu_groupby_parallel_degree=2;

## query
select sum(id),name from t1 group by name order by name;

## log 

set global tianmu_slow_query_record_interval=2;

# MORE

drop table t1;

CREATE TABLE t1 (
  spID int(10) unsigned,
  userID int(10) unsigned,
  score int(5) unsigned,
  lsg char(40)
) ENGINE=TIANMU;

INSERT INTO t1 VALUES (1,1,1,'');
INSERT INTO t1 VALUES (2,2,2,'');
INSERT INTO t1 VALUES (2,1,1,'');
INSERT INTO t1 VALUES (3,3,3,'');

CREATE TABLE t2 (
  userID int(10),
  niName char(15),
  passwd char(8),
  mail char(50),
  vName char(30),
  nName char(40),
  adr char(60),
  plz char(5),
  ort char(35),
  land char(20)
) ENGINE=TIANMU;

INSERT INTO t2 VALUES (1,'name','pass','mail','v','n','adr','1','1','1');
INSERT INTO t2 VALUES (2,'name','pass','mail','v','n','adr','1','1','1');
INSERT INTO t2 VALUES (3,'name','pass','mail','v','n','adr','1','1','1');
INSERT INTO t2 VALUES (4,'name','pass','mail','v','n','adr','1','1','1');
INSERT INTO t2 VALUES (5,'name','pass','mail','v','n','adr','1','1','1');

SELECT t2.userid, MIN(t1.score) FROM t1, t2 WHERE t1.userID=t2.userID GROUP BY t2.userid;
SELECT t2.userid, MIN(t1.score) FROM t1, t2 WHERE t1.userID=t2.userID GROUP BY t2.userid ORDER BY NULL;
SELECT t2.userid, MIN(t1.score) FROM t1, t2 WHERE t1.userID=t2.userID AND t1.spID=2  GROUP BY t2.userid;
SELECT t2.userid, MIN(t1.score+0.0) FROM t1, t2 WHERE t1.userID=t2.userID AND t1.spID=2  GROUP BY t2.userid;
SELECT t2.userid, MIN(t1.score+0.0) FROM t1, t2 WHERE t1.userID=t2.userID AND t1.spID=2  GROUP BY t2.userid ORDER BY NULL;

drop table t1,t2;

# clean

drop database issue422_test;