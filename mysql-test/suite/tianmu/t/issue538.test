--source include/have_tianmu.inc

--echo #
--echo # issue 538 test for user defined function of tianmu
--echo #

use test;

--disable_warnings
DROP TABLE IF EXISTS employees;

CREATE TABLE `employees` (
  `employee_id` int(11) NOT NULL ,
  `employee_name` varchar(50) NOT NULL,
  `employee_sex` varchar(10) DEFAULT 'men',
  `hire_date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `employee_mgr` int(11) DEFAULT NULL,
  `employee_salary` float DEFAULT '3000',
  `department_id` int(11) DEFAULT NULL
) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;

--disable_warnings
DROP FUNCTION IF EXISTS get_value;

CREATE FUNCTION get_value(id INT) RETURNS VARCHAR(300) 
  RETURN (SELECT CONCAT('employee name:',employee_name,'---','salary: ',employee_salary) FROM employees WHERE employee_id=id);

--disable_query_log
insert into employees(employee_id,employee_name,employee_sex,employee_mgr,employee_salary,department_id) values (1,'David Tian','man',10,7500,1);
insert into employees(employee_id,employee_name,employee_sex,employee_mgr,employee_salary,department_id) values (2,'Black Xie','man',10,6600,1);
insert into employees(employee_id,employee_name,employee_sex,employee_mgr,employee_salary,department_id) values (3,'Moses Wang','man',10,4300,1);
insert into employees(employee_id,employee_name,employee_sex,employee_mgr,employee_salary,department_id) values (4,'Rena Ruan','woman',10,5300,1);
insert into employees(employee_id,employee_name,employee_sex,employee_mgr,employee_salary,department_id) values (5,'Sunshine Ma','woman',10,6500,2);

--enable_query_log
SELECT
	a.employee_id,
	get_value(b.employee_id)
FROM
	employees a
LEFT JOIN employees b ON
	a.employee_id = b.employee_id
	and b.employee_name = 'David Tian';

SELECT get_value(1);
SELECT get_value(1),get_value(1);
SELECT get_value(1),get_value(1),get_value(1);
SELECT 1,get_value(1);
SELECT 1,2,get_value(1);

DROP TABLE employees;
DROP FUNCTION get_value;


--disable_warnings
DROP TABLE IF EXISTS tf;

CREATE TABLE tf (a int) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;

--disable_warnings
DROP FUNCTION IF EXISTS sfunc;

CREATE FUNCTION sfunc (a int) RETURNS int RETURN (a+1);
INSERT tf VALUES(1);

SELECT sfunc(2);

DROP TABLE tf;
DROP FUNCTION sfunc;

