#
# issue 538 test for user defined function of tianmu
#
use test;
DROP TABLE IF EXISTS employees;
CREATE TABLE `employees` (
`employee_id` int(11) NOT NULL ,
`employee_name` varchar(50) NOT NULL,
`employee_sex` varchar(10) DEFAULT 'men',
`hire_date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`employee_mgr` int(11) DEFAULT NULL,
`employee_salary` float DEFAULT '3000',
`department_id` int(11) DEFAULT NULL
) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;
DROP FUNCTION IF EXISTS get_desc;
DROP FUNCTION IF EXISTS get_int;
CREATE FUNCTION get_desc(id INT) RETURNS VARCHAR(300) 
RETURN (SELECT CONCAT('employee name:',employee_name,'---','salary: ',employee_salary) FROM employees WHERE employee_id=id);
CREATE FUNCTION get_int(id INT) RETURNS VARCHAR(300) 
RETURN (SELECT employee_salary FROM employees WHERE employee_id=id);
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
a.employee_id = b.employee_id
and b.employee_name = 'David Tian';
employee_id	get_desc(b.employee_id)
1	employee name:David Tian---salary: 7500
2	NULL
3	NULL
4	NULL
5	NULL
SELECT
sum(200 + get_int(b.employee_id))
FROM
employees a
LEFT JOIN employees b ON
a.employee_id = b.employee_id
and b.employee_name = 'David Tian';
sum(200 + get_int(b.employee_id))
7700
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
a.employee_salary = get_int(b.employee_id)
and b.employee_name = 'David Tian';
employee_id	get_desc(b.employee_id)
1	employee name:David Tian---salary: 7500
2	NULL
3	NULL
4	NULL
5	NULL
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
b.employee_name = 'David Tian'
WHERE
a.employee_salary < get_int(b.employee_id);
employee_id	get_desc(b.employee_id)
2	employee name:David Tian---salary: 7500
5	employee name:David Tian---salary: 7500
4	employee name:David Tian---salary: 7500
3	employee name:David Tian---salary: 7500
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
b.employee_name = 'David Tian'
WHERE
a.employee_salary > get_int(b.employee_id);
employee_id	get_desc(b.employee_id)
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
b.employee_name = 'David Tian'
WHERE
a.employee_salary = get_int(b.employee_id);
employee_id	get_desc(b.employee_id)
1	employee name:David Tian---salary: 7500
SELECT
a.employee_id,
get_desc(b.employee_id)
FROM
employees a
LEFT JOIN employees b ON
b.employee_name = 'David Tian'
WHERE
get_int(b.employee_id) = a.employee_salary;
employee_id	get_desc(b.employee_id)
1	employee name:David Tian---salary: 7500
SELECT
get_desc(a.employee_id),
b.employee_salary
FROM
employees as a,
(
select
get_int(employees.employee_id) as employee_salary
from
employees) as b
WHERE
a.employee_name = 'David Tian'
	AND a.employee_salary = b.employee_salary;
get_desc(a.employee_id)	employee_salary
employee name:David Tian---salary: 7500	7500
SELECT
get_desc(a.employee_id),
b.employee_salary
FROM
employees as a,
(
select
get_int(e.employee_id) as employee_salary
from
(
SELECT
c.employee_id
FROM
(
SELECT
employee_id,
get_int(employees.employee_id) as employee_salary
FROM
employees
WHERE
employee_salary > 500) as c) as e ) as b
WHERE
a.employee_name = 'David Tian'
	AND a.employee_salary = b.employee_salary;
get_desc(a.employee_id)	employee_salary
employee name:David Tian---salary: 7500	7500
SELECT get_desc(1);
get_desc(1)
employee name:David Tian---salary: 7500
SELECT get_desc(1),get_desc(1);
get_desc(1)	get_desc(1)
employee name:David Tian---salary: 7500	employee name:David Tian---salary: 7500
SELECT get_desc(1),get_desc(1),get_desc(1);
get_desc(1)	get_desc(1)	get_desc(1)
employee name:David Tian---salary: 7500	employee name:David Tian---salary: 7500	employee name:David Tian---salary: 7500
SELECT 1,get_desc(1);
1	get_desc(1)
1	employee name:David Tian---salary: 7500
SELECT 1,2,get_desc(1);
1	2	get_desc(1)
1	2	employee name:David Tian---salary: 7500
DROP TABLE employees;
DROP FUNCTION get_desc;
DROP FUNCTION get_int;
DROP TABLE IF EXISTS tf;
CREATE TABLE tf (a int) ENGINE=TIANMU DEFAULT CHARSET=utf8mb4;
DROP FUNCTION IF EXISTS sfunc;
CREATE FUNCTION sfunc (a int) RETURNS int RETURN (a+1);
INSERT tf VALUES(1);
SELECT sfunc(2);
sfunc(2)
3
DROP TABLE tf;
DROP FUNCTION sfunc;
