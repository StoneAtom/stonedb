pipeline {
    agent {
        label 'agent-30-208'
    }

    options{
        disableConcurrentBuilds()
        timeout(time:2, unit: 'HOURS')
    }

    stages {

        stage('Compile') {

            steps {
                sh label: 'make', 
                script: """set -e

                    gcc -v

                    cd scripts
                    bash stonedb_build.sh
                    """
            }
        }

        stage('ReStartSvc') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    echo "restart"

                '''
            }
        }

        stage('RunTest') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    echo "run test"

                '''
            }
        }
        
    } // stages

    post { 
        failure { 
            sh label: '', 
            script:'''
               echo "failure"
            '''
        }

		unstable { 
            sh label: '', 
            script:'''
                echo "unstable"    
            '''
        }

        success { 
            sh label: '', 
            script:'''
               echo "success"
            '''
        }
    }
}
