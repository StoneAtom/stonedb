pipeline {
    agent {
        label 'agent-30-208'
    }

    options{
        disableConcurrentBuilds()
        timeout(time:2, unit: 'HOURS')
    }

    stages {

        stage('Compile') {

            steps {
                sh label: 'make', 
                script: """set -e

                    cd scripts
                    bash stonedb_build.sh
                    """
            }
        }

        // 并行测试
        stage('RunTestsParallel') {
            parallel {

                stage('run_test1') {
                    steps {
                        script {
					     catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
					     	sh label: 'test1', 
					     	script: '''
                                pwd
					     		'''
					        }
				        }
                    }
                }

        stage('ReStartSvc') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                

                '''
            }
        }
        
    } // stages

    post { 
        failure { 
            sh label: '', 
            script:'''
               echo "failure"
            '''
        }

		unstable { 
            sh label: '', 
            script:'''
                echo "unstable"    
            '''
        }

        success { 
            sh label: '', 
            script:'''

               echo "success"

            '''
        }
    }


}