pipeline {
    agent {
        label 'agent-30-208'
    }

    options{
        disableConcurrentBuilds()
        timeout(time:2, unit: 'HOURS')
    }

    stages {

        stage('CreeateDir') {

            steps {
                sh label: 'make', 
                script: """set -e

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    pkill -9 mysqld && set ?=0
                    sleep 5s

                    rm /stonedb56 -rf
                    rm /var/lib/mysql -rf

                    rm /data/stonedb56 -rf
                    mkdir -p /data/stonedb56
                    ln -s /data/stonedb56 /stonedb56
                    mkdir -p /stonedb56/install

                    groupadd mysql && set ?=0
                    useradd -g mysql mysql && set ?=0

                    mkdir -p /stonedb56/install/{log/,tmp/,binlog/,data/innodb}
                    mkdir -p /var/lib/mysql/
                    touch /stonedb56/install/log/stonedb.log

                    chown -R mysql:mysql /data/*
                    chown -R mysql:mysql /stonedb56
                    chown -R mysql:mysql /stonedb56/*
                    chown -R mysql:mysql /var/lib/mysql/

                """
            }
        }

        stage('CompileStonedb') {

            steps {
                sh label: 'make', 
                script: """set -e

                    gcc -v

                    cd scripts
                    bash stonedb_build.sh
                    """
            }
        }

        stage('ReFixDir') {

            steps {
                sh label: 'make', 
                script: """set -e

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    pkill -9 mysqld && set ?=0
                    sleep 5s

                    mkdir -p /data/stonedb56
                    ln -s /data/stonedb56 /stonedb56
                    mkdir -p /stonedb56/install

                    groupadd mysql && set ?=0
                    useradd -g mysql mysql && set ?=0

                    mkdir -p /stonedb56/install/{log/,tmp/,binlog/,data/innodb}
                    mkdir -p /var/lib/mysql/
                    touch /stonedb56/install/log/stonedb.log

                    chown -R mysql:mysql /data/*
                    chown -R mysql:mysql /stonedb56
                    chown -R mysql:mysql /stonedb56/*
                    chown -R mysql:mysql /var/lib/mysql/

                """
            }
        }

        stage('ReStartStonedb') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    /stonedb56/install/bin/mysqld --user=mysql stop && set ?=0
 
                    pkill -9 mysqld && set ?=0

                    sleep 5s

                    /stonedb56/install/scripts/mysql_install_db.sh  --user=mysql  --basedir=/stonedb56/install --datadir=/stonedb56/install/data && set ?=0

                    sleep 3s

                    /stonedb56/install/bin/mysqld --user=mysql --skip-grant-tables &

                    echo "restart ok"

                '''
            }
        }


        stage('ImportTPCHData') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    TB_TPCH_NUM=`/stonedb56/install/bin/mysql -e "show databases;" | grep tpch | grep -v grep | wc -l`

                    if [ "0" != "$TB_TPCH_NUM" ]; then
                        echo "tpch data has imported"
                        exit 0
                    fi

                    cd tests/tpc-h

                    rm tpc-h -rf
                    tar -xzvf tpc-h.tar.gz
                    cd tpc-h
                    cd dbgen

                    make -j`nproc`
                    
                    # GB
                    ./dbgen -s 1
                    mkdir -p stonedb/
                    mv *.tbl stonedb/
                    
                    cp dss.ddl stonedb/dss_stonedb.ddl		

                    /stonedb56/install/bin/mysql -e "create database tpch;"

                    /stonedb56/install/bin/mysql -D tpch -e "source ./stonedb/dss_stonedb.ddl "

                    /stonedb56/install/bin/mysql -D tpch < ./stonedb.sql

                    /stonedb56/install/bin/mysql -D tpch -e " show tables; "

                    bash ./split_file2db.sh 

                    cd ../..
                    rm tpc-h -rf

                '''
            }
        }

        stage('RunTestSubQuery') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                    /stonedb56/install/bin/mysql -D tpch -e "select
                            o_orderpriority,
                            count(*) as order_count
                        from
                            orders
                        where
                            o_orderdate >= date '1993-07-01'
                            and o_orderdate < date '1993-07-01' + interval '3' month
                            and exists (
                                select
                                    *
                                from
                                    lineitem
                                where
                                    l_orderkey = o_orderkey
                                    and l_commitdate < l_receiptdate
                            )
                        group by
                            o_orderpriority
                        order by
                            o_orderpriority ;"


                '''
            }
        }

        stage('RunTestSubQueryExplain') {
            steps {
                sh label: '', 
                script: '''

                    JENKINS_NODE_COOKIE=dontKillMe
                    export JENKINS_NODE_COOKIE=dontKillMe

                
                    /stonedb56/install/bin/mysql -D tpch -e "explain select
                            o_orderpriority,
                            count(*) as order_count
                        from
                            orders
                        where
                            o_orderdate >= date '1993-07-01'
                            and o_orderdate < date '1993-07-01' + interval '3' month
                            and exists (
                                select
                                    *
                                from
                                    lineitem
                                where
                                    l_orderkey = o_orderkey
                                    and l_commitdate < l_receiptdate
                            )
                        group by
                            o_orderpriority
                        order by
                            o_orderpriority ;"


                '''
            }
        }
        
    } // stages

    post { 
        failure { 
            sh label: '', 
            script:'''
               echo "failure"
            '''
        }

		unstable { 
            sh label: '', 
            script:'''
                echo "unstable"    
            '''
        }

        success { 
            sh label: '', 
            script:'''
               echo "success"
            '''
        }
    }
}
